
<!DOCTYPE html>
<html>
<head>
    <title>表情识别系统</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <style>
        :root {
            --bg: #f5f7fa;
            --bg-grad-1: #f5f7fa;
            --bg-grad-2: #e8ecf1;
            --text: #263238;
            --muted: #607d8b;
            --brand: #6366f1;
            --brand-2: #818cf8;
            --card: #ffffff;
            --shadow: 0 10px 25px rgba(0,0,0,0.08);
            --radius: 14px;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
            color: var(--text);
            background: linear-gradient(180deg, var(--bg-grad-1) 0%, var(--bg-grad-2) 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(90deg, var(--brand) 0%, var(--brand-2) 100%);
            color: white;
            padding: 26px 18px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        .header h1 { margin: 0; font-size: 2.2em; letter-spacing: 1px; }
        .header p { margin: 8px 0 0; color: #e0e7ff; }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 32px auto;
            padding: 0 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 24px;
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 22px;
        }

        .section-title {
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }
        .section-title .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--brand-2); display: inline-block; }

        /* Upload */
        .upload-wrap { display: grid; gap: 16px; }
        .dropzone {
            border: 2px dashed #c7d2fe;
            background: #eef2ff;
            border-radius: var(--radius);
            padding: 22px;
            text-align: center;
            transition: 0.2s ease;
        }
        .dropzone.dragover { background: #e0e7ff; border-color: #818cf8; }
        .dropzone h3 { margin: 8px 0 6px 0; }
        .dropzone p { margin: 0; color: var(--muted); font-size: 14px; }

        .controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .file-input { display: none; }
        .btn {
            appearance: none;
            border: none;
            padding: 11px 18px;
            border-radius: 10px;
            background: var(--brand);
            color: #fff;
            cursor: pointer;
            transition: transform .04s ease, box-shadow .2s ease, background .2s ease;
            box-shadow: 0 6px 14px rgba(46,125,50,0.25);
        }
        .btn.secondary { background: #eceff1; color: #37474f; box-shadow: none; }
        .btn:disabled { opacity: .6; cursor: not-allowed; box-shadow: none; }
        .btn:hover { background: var(--brand-2); }
        .btn:active { transform: translateY(1px); }

        .preview {
            display: grid;
            grid-template-columns: 1fr;
            justify-items: center;
            gap: 12px;
        }
        .preview img {
            max-width: min(100%, 460px);
            max-height: 400px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            background: #fafafa;
            object-fit: contain;
        }
        .hint { color: var(--muted); font-size: 12px; }

        /* Results */
        .results-wrap { display: grid; gap: 14px; }
        .result-box { background: #eef2ff; border-radius: var(--radius); padding: 16px; min-height: 120px; }
        #out { margin: 0; font-family: inherit; white-space: normal; }
        .result-item { padding: 12px 14px; border-radius: 10px; color: #ffffff; font-weight: 600; }
        .result-item + .result-item { margin-top: 8px; }
        .result-item .tag { opacity: .9; font-size: 12px; margin-left: 8px; }

        /* 表情颜色 */
        .emotion-anger { background: #F44336; }      /* 愤怒 - 红色 */
        .emotion-disgust { background: #795548; }    /* 厌恶 - 棕色 */
        .emotion-fear { background: #9C27B0; }       /* 恐惧 - 紫色 */
        .emotion-happy { background: #FF9800; }      /* 快乐 - 橙色 */
        .emotion-neutral { background: #9E9E9E; }    /* 中性 - 灰色 */
        .emotion-sad { background: #2196F3; }        /* 悲伤 - 蓝色 */
        .emotion-surprise { background: #FF5722; }   /* 惊讶 - 深橙红色 */

        .legend { display: grid; gap: 10px; grid-template-columns: repeat(2, 1fr); }
        @media (min-width: 1200px) {
            .legend { grid-template-columns: repeat(3, 1fr); }
        }
        .legend-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #ffffff; border-radius: 10px; box-shadow: var(--shadow); }
        .legend-item .swatch { width: 14px; height: 14px; border-radius: 4px; }


        .error { color: #F44336; padding: 12px; background: #ffebee; border-radius: 8px; margin: 10px 0; }
        .loading { color: var(--brand); padding: 12px; background: #eef2ff; border-radius: 8px; margin: 10px 0; }

        .footer { text-align: center; color: #90a4ae; font-size: 12px; padding: 24px 0 32px; }

        @media (max-width: 980px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>表情识别系统</h1>
        <p>基于深度学习的面部表情识别，支持7种情绪分析</p>
    </div>

    <div class="container">
        <div class="grid">
            <div class="card">
                <div class="section-title"><span class="dot"></span><span>上传待识别图片</span></div>
                <div class="upload-wrap">
                    <div class="dropzone" id="dropzone">
                        <h3>拖拽图片到此或点击选择</h3>
                        <p>支持 JPG / JPEG / PNG / BMP</p>
                    </div>
                    <div class="controls">
                        <label class="btn secondary" for="file0">选择图片</label>
                        <input class="file-input" type="file" name="file" id="file0" accept="image/*">
                        <button class="btn" id="b0" onclick="predictImage()">开始识别</button>
                        <span class="hint" id="hint">未选择文件</span>
                    </div>
                    <div class="preview">
                        <img src="" id="img0" alt="预览图" style="display:none;">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="section-title"><span class="dot"></span><span>识别结果</span></div>
                <div class="results-wrap">
                    <div class="result-box">
                        <div id="out"></div>
                    </div>
                    <div class="legend">
                        <div class="legend-item"><span class="swatch emotion-anger"></span><strong>愤怒 (Anger)</strong><span class="hint">愤怒情绪</span></div>
                        <div class="legend-item"><span class="swatch emotion-disgust"></span><strong>厌恶 (Disgust)</strong><span class="hint">厌恶情绪</span></div>
                        <div class="legend-item"><span class="swatch emotion-fear"></span><strong>恐惧 (Fear)</strong><span class="hint">恐惧情绪</span></div>
                        <div class="legend-item"><span class="swatch emotion-happy"></span><strong>快乐 (Happy)</strong><span class="hint">快乐情绪</span></div>
                        <div class="legend-item"><span class="swatch emotion-neutral"></span><strong>中性 (Neutral)</strong><span class="hint">中性情绪</span></div>
                        <div class="legend-item"><span class="swatch emotion-sad"></span><strong>悲伤 (Sad)</strong><span class="hint">悲伤情绪</span></div>
                        <div class="legend-item"><span class="swatch emotion-surprise"></span><strong>惊讶 (Surprise)</strong><span class="hint">惊讶情绪</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">© 表情识别系统 - 基于VGG网络的深度学习表情识别</div>
    </div>

<script type="text/javascript">
    function setPreview(file) {
        if (!file) { return; }
        var objUrl = getObjectURL(file);
        if (objUrl) {
            $("#img0").attr("src", objUrl).show();
            $("#hint").text(file.name);
        }
    }

    $("#file0").on('change', function(){
        var file = this.files && this.files[0];
        setPreview(file);
    });

    // 拖拽上传
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file0');
    ['dragenter', 'dragover'].forEach(evt => {
        dropzone.addEventListener(evt, function(e){ e.preventDefault(); e.stopPropagation(); this.classList.add('dragover'); });
    });
    ['dragleave', 'drop'].forEach(evt => {
        dropzone.addEventListener(evt, function(e){ e.preventDefault(); e.stopPropagation(); this.classList.remove('dragover'); });
    });
    dropzone.addEventListener('click', function(){ fileInput.click(); });
    dropzone.addEventListener('drop', function(e){
        const dt = e.dataTransfer; const files = dt && dt.files;
        if (files && files[0]) {
            fileInput.files = files;
            setPreview(files[0]);
        }
    });

    function setLoading(loading) {
        const btn = document.getElementById('b0');
        if (loading) {
            btn.setAttribute('disabled', 'disabled');
            $("#out").html('<div class="loading">正在识别中，请稍候...</div>');
        } else {
            btn.removeAttribute('disabled');
        }
    }

    function predictImage() {
        var fileobj = $("#file0")[0].files[0];
        if (!fileobj) {
            $("#out").html('<div class="error">请先选择图片文件</div>');
            return;
        }

        var form = new FormData();
        form.append("file", fileobj);

        setLoading(true);

        $.ajax({
            type: 'POST',
            url: "/predict",
            data: form,
            async: true,
            processData: false,
            contentType: false,
            success: function (arg) {
                var results = '';
                if (arg.result && Array.isArray(arg.result)) {
                    arg.result.forEach(e => {
                        // 处理识别结果，匹配表情类别
                        let className = 'emotion-neutral';
                        let emotionName = '';
                        var resultStr = String(e).toLowerCase();
                        
                        // 匹配表情
                        if (resultStr.includes('anger') || resultStr.includes('angry') || resultStr.includes('愤怒')) {
                            className = 'emotion-anger';
                            emotionName = '愤怒 (Anger)';
                        } else if (resultStr.includes('disgust') || resultStr.includes('厌恶')) {
                            className = 'emotion-disgust';
                            emotionName = '厌恶 (Disgust)';
                        } else if (resultStr.includes('fear') || resultStr.includes('恐惧')) {
                            className = 'emotion-fear';
                            emotionName = '恐惧 (Fear)';
                        } else if (resultStr.includes('happy') || resultStr.includes('快乐') || resultStr.includes('高兴')) {
                            className = 'emotion-happy';
                            emotionName = '快乐 (Happy)';
                        } else if (resultStr.includes('neutral') || resultStr.includes('中性')) {
                            className = 'emotion-neutral';
                            emotionName = '中性 (Neutral)';
                        } else if (resultStr.includes('sad') || resultStr.includes('悲伤')) {
                            className = 'emotion-sad';
                            emotionName = '悲伤 (Sad)';
                        } else if (resultStr.includes('surprise') || resultStr.includes('惊讶') || resultStr.includes('amazing')) {
                            className = 'emotion-surprise';
                            emotionName = '惊讶 (Surprise)';
                        } else {
                            // 如果没有匹配到，使用原始结果
                            emotionName = e;
                        }
                        
                        // 提取置信度（如果有）
                        // 匹配 "：置信度 0.xxxx" 格式
                        var confidenceMatch = resultStr.match(/置信度\s*([\d.]+)/);
                        if (!confidenceMatch) {
                            // 如果没有匹配到，尝试匹配其他数字格式
                            confidenceMatch = resultStr.match(/(\d+\.?\d*)/);
                        }
                        var confidenceText = '';
                        if (confidenceMatch) {
                            var confidence = parseFloat(confidenceMatch[1]);
                            confidenceText = ` (置信度: ${(confidence * 100).toFixed(2)}%)`;
                        }
                        
                        results += `<div class="result-item ${className}">识别结果：${emotionName}${confidenceText}</div>`;
                    });
                } else {
                    results = '<div class="error">返回结果格式错误</div>';
                }
                $("#out").html(results);
                setLoading(false);
            },
            error: function(xhr, status, error){
                $("#out").html(`<div class="error">识别失败，请重试 (${status})</div>`);
                console.log("AJAX Error:", error);
                setLoading(false);
            }
        });
    }

    // 获取文件URL
    function getObjectURL(file) {
        var url = null;
        if (window.createObjectURL != undefined) {
            url = window.createObjectURL(file);
        } else if (window.URL != undefined) {
            url = window.URL.createObjectURL(file);
        } else if (window.webkitURL != undefined) {
            url = window.webkitURL.createObjectURL(file);
        }
        return url;
    }
</script>

</body>
</html>