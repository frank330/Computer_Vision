<!DOCTYPE html>
<html>
<head>
    <title>基于U-Net的肠道息肉检测系统</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
            background: #f5f5f5;
            color: #333;
            background-image: linear-gradient(to bottom, #f5f5f5, #e5e5e5);
        }

        .header {
            background: #2196F3;  /* 医疗蓝色主题 */
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin: 10px 0 0;
            font-size: 1.2em;
            color: #E3F2FD;  /* 浅蓝色 */
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .upload-section {
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #BBDEFB;
            margin-bottom: 30px;
        }

        .file-upload {
            position: relative;
            margin: 20px auto;
            width: 200px;
        }

        .file-upload-btn {
            display: inline-block;
            padding: 12px 30px;
            background: #2196F3;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-btn:hover {
            background: #1976D2;
        }

        .preview-image {
            max-width: 400px;
            max-height: 400px;
            margin: 20px 0;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .predict-btn {
            padding: 12px 40px;
            background: #42A5F5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .predict-btn:hover {
            background: #2196F3;
        }

        .predict-btn:disabled {
            background: #BBDEFB;
            cursor: not-allowed;
        }

        .result-section {
            padding: 20px;
        }

        .result-section h2 {
            color: #1976D2;
            border-bottom: 2px solid #BBDEFB;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .comparison-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }

        .image-box {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            padding: 15px;
            background: #E3F2FD;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .image-box h3 {
            color: #1976D2;
            margin: 0 0 15px 0;
            font-size: 1.2em;
        }

        .image-box img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: none;
        }

        .image-box img.show {
            display: block;
        }

        .result-info {
            margin-top: 20px;
            padding: 15px;
            background: #E3F2FD;
            border-radius: 5px;
            text-align: center;
        }

        .result-info.success {
            background: #C8E6C9;
            color: #2E7D32;
        }

        .result-info.error {
            background: #FFCDD2;
            color: #C62828;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #1976D2;
        }

        .polyp-info {
            margin-top: 40px;
            padding: 20px;
            background: #E3F2FD;
            border-radius: 5px;
        }

        .polyp-info h3 {
            color: #1976D2;
            margin-bottom: 15px;
            border-bottom: 2px solid #BBDEFB;
            padding-bottom: 10px;
        }

        .info-item {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .info-item h4 {
            color: #1976D2;
            margin: 0 0 10px 0;
        }

        .info-item p {
            margin: 5px 0;
            color: #666;
            line-height: 1.6;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #BBDEFB;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #1976D2;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>基于U-Net的肠道息肉检测系统</h1>
        <p>智能识别肠道息肉，提供精准分割结果和可视化对比</p>
    </div>

    <div class="container">
        <div class="upload-section">
            <h2>上传肠道内镜图像</h2>
            <div class="file-upload">
                <div class="file-upload-btn">选择图片文件</div>
                <input type="file" name="file" id="file0" accept="image/*" style="display: none;">
            </div>
            <img src="" id="img0" class="preview-image" style="display: none;">
            <br>
            <button class="predict-btn" id="predictBtn" onclick="startDetection()">开始检测</button>
        </div>

        <div class="result-section">
            <h2>检测结果对比</h2>
            <div id="resultInfo" style="display: none;"></div>
            <div class="comparison-container" id="comparisonContainer" style="display: none;">
                <div class="image-box">
                    <h3>原始图像</h3>
                    <img id="originalImage" src="" alt="原始图像">
                </div>
                <div class="image-box">
                    <h3>分割结果</h3>
                    <img id="maskImage" src="" alt="分割结果">
                </div>
                <div class="image-box">
                    <h3>叠加显示</h3>
                    <img id="overlayImage" src="" alt="叠加图像">
                </div>
            </div>
            <div class="polyp-info">
                <h3>关于肠道息肉</h3>
                <div class="info-item">
                    <h4>什么是肠道息肉？</h4>
                    <p>肠道息肉是指肠黏膜表面向肠腔突出的隆起性病变，是常见的肠道疾病。大多数息肉是良性的，但部分息肉可能发展为结直肠癌，因此早期发现和诊断非常重要。</p>
                </div>
                <div class="info-item">
                    <h4>检测意义</h4>
                    <p>通过内镜图像进行息肉检测和分割，可以帮助医生：</p>
                    <p>1. 快速定位息肉位置</p>
                    <p>2. 评估息肉大小和形态</p>
                    <p>3. 辅助制定治疗方案</p>
                    <p>4. 提高诊断效率和准确性</p>
                </div>
                <div class="info-item">
                    <h4>技术说明</h4>
                    <p>本系统基于U-Net深度学习模型，采用语义分割技术，能够自动识别和分割肠道息肉区域。红色高亮区域表示检测到的息肉位置。</p>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // 文件选择按钮点击事件
        $(".file-upload-btn").click(function(){
            $("#file0").click();
        });

        // 文件选择变化事件
        $("#file0").change(function(){
            var objUrl = getObjectURL(this.files[0]);
            if (objUrl) {
                $("#img0").attr("src", objUrl).show();
            }
        });

        // 开始检测
        function startDetection() {
            var fileobj = $("#file0")[0].files[0];
            if (!fileobj) {
                showResult("请先选择图片文件", false);
                return;
            }
            
            // 禁用按钮，显示加载状态
            $("#predictBtn").prop("disabled", true).text("检测中...");
            
            var form = new FormData();
            form.append("file", fileobj);
            
            // 隐藏之前的结果
            $("#comparisonContainer").hide();
            showResult("正在检测中，请稍候...", true);
            
            $.ajax({
                type: 'POST',
                url: "predict",
                data: form,
                async: true,
                processData: false,
                contentType: false,
                success: function (response) {
                    $("#predictBtn").prop("disabled", false).text("开始检测");
                    
                    if (response.success) {
                        // 显示成功信息
                        showResult(response.message, true, true);
                        
                        // 显示对比图像，添加时间戳防止缓存
                        var timestamp = new Date().getTime();
                        $("#originalImage").attr("src", "original.jpg?" + timestamp).addClass("show");
                        $("#maskImage").attr("src", "mask.jpg?" + timestamp).addClass("show");
                        $("#overlayImage").attr("src", "overlay.jpg?" + timestamp).addClass("show");
                        
                        // 显示对比容器
                        $("#comparisonContainer").show();
                    } else {
                        showResult(response.message || "检测失败", false);
                    }
                },
                error: function(xhr, status, error){
                    $("#predictBtn").prop("disabled", false).text("开始检测");
                    showResult("检测失败，请重试。错误信息: " + error, false);
                }
            });
        }

        // 显示结果信息
        function showResult(message, isLoading, isSuccess) {
            var infoDiv = $("#resultInfo");
            infoDiv.removeClass("success error");
            
            if (isLoading) {
                infoDiv.html('<div class="loading">' + message + '</div>');
            } else if (isSuccess) {
                infoDiv.html('<div class="result-info success">' + message + '</div>').addClass("success");
            } else {
                infoDiv.html('<div class="result-info error">' + message + '</div>').addClass("error");
            }
            
            infoDiv.show();
        }

        // 获取文件对象URL
        function getObjectURL(file) {
            var url = null;
            if (window.createObjectURL != undefined) {
                url = window.createObjectURL(file);
            } else if (window.URL != undefined) {
                url = window.URL.createObjectURL(file);
            } else if (window.webkitURL != undefined) {
                url = window.webkitURL.createObjectURL(file);
            }
            return url;
        }
    </script>
</body>
</html>
